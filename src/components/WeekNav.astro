---
interface Props {
  currentDate: string;
  availableDates: string[];
}

const { currentDate, availableDates } = Astro.props;

// Parse date parts to avoid timezone issues
const [year, month, day] = currentDate.split('-').map(Number);
const currentDateObj = new Date(year, month - 1, day, 12, 0, 0); // noon to avoid DST issues

const dayOfWeek = currentDateObj.getDay(); // 0 = Sunday
const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

// Generate the week's dates (Mon-Sun)
const weekDates: { date: string; dayLetter: string; isToday: boolean; hasWorkout: boolean; isCurrent: boolean }[] = [];
const dayLetters = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

for (let i = 0; i < 7; i++) {
  const d = new Date(year, month - 1, day + mondayOffset + i, 12, 0, 0);
  const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

  weekDates.push({
    date: dateStr,
    dayLetter: dayLetters[i],
    isToday: false, // Will be set client-side
    hasWorkout: availableDates.includes(dateStr),
    isCurrent: dateStr === currentDate
  });
}

// Find prev/next available dates
const sortedDates = [...availableDates].sort();
const currentIdx = sortedDates.indexOf(currentDate);
const prevDate = currentIdx > 0 ? sortedDates[currentIdx - 1] : null;
const nextDate = currentIdx < sortedDates.length - 1 ? sortedDates[currentIdx + 1] : null;
---

<nav class="flex items-center justify-between mb-6">
  <!-- Prev arrow -->
  <a
    href={prevDate ? `/day/${prevDate}` : '#'}
    class={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${prevDate ? 'bg-[var(--color-card)] border border-[var(--color-border)] hover:border-[var(--color-lime)]' : 'opacity-30 pointer-events-none'}`}
  >
    <svg class="w-5 h-5 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
  </a>

  <!-- Week days -->
  <div class="flex gap-1">
    {weekDates.map((day) => (
      <a
        href={day.hasWorkout ? `/day/${day.date}` : '#'}
        data-date={day.date}
        class={`
          week-day-btn w-9 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-mono transition-all
          ${day.isCurrent ? 'bg-lime text-black' : ''}
          ${!day.isCurrent && day.hasWorkout ? 'bg-[var(--color-card)] border border-[var(--color-border)] hover:border-[var(--color-lime)] text-[var(--color-text)]' : ''}
          ${!day.isCurrent && !day.hasWorkout ? 'text-[var(--color-text-dim)] pointer-events-none' : ''}
        `}
      >
        <span class="text-[10px] opacity-70">{day.dayLetter}</span>
        <span class="day-num font-semibold">
          {parseInt(day.date.split('-')[2])}
        </span>
      </a>
    ))}
  </div>

  <!-- Next arrow -->
  <a
    href={nextDate ? `/day/${nextDate}` : '#'}
    class={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${nextDate ? 'bg-[var(--color-card)] border border-[var(--color-border)] hover:border-[var(--color-lime)]' : 'opacity-30 pointer-events-none'}`}
  >
    <svg class="w-5 h-5 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </a>
</nav>

<script>
  // Mark today's date based on user's local timezone
  const userToday = new Date().toLocaleDateString('en-CA');
  document.querySelectorAll('.week-day-btn').forEach(btn => {
    const date = btn.getAttribute('data-date');
    const dayNum = btn.querySelector('.day-num');
    if (date === userToday && dayNum && !btn.classList.contains('bg-lime')) {
      dayNum.classList.add('underline', 'decoration-lime');
    }
  });
</script>
