---
import Layout from '../layouts/Layout.astro';
import WeekNav from '../components/WeekNav.astro';

// Import data
import plan from '../../data/plan.json';
import log from '../../data/log.json';

// Build a map of all dates with their plan and log data
const allData: Record<string, { plan: any; log: any }> = {};
const allDates: string[] = [];

for (const week of Object.values(plan.weeks) as Record<string, any>[]) {
  for (const [date, dayPlan] of Object.entries(week)) {
    allDates.push(date);
    allData[date] = {
      plan: dayPlan,
      log: (log as Record<string, any>)[date] || null
    };
  }
}

const sortedDates = allDates.sort();
const availableDates = [...sortedDates];

// For server-side render, use most recent date as default
const defaultDate = sortedDates[sortedDates.length - 1] || new Date().toLocaleDateString('en-CA');
---

<Layout title="Treino - Today's Workout">
  <div class="px-4 pt-6 max-w-lg mx-auto">
    <!-- Week Navigation - will be updated client-side -->
    <div id="week-nav-container">
      <WeekNav currentDate={defaultDate} availableDates={availableDates} />
    </div>

    <!-- Content container - rendered client-side -->
    <div id="workout-content">
      <div class="text-center py-12">
        <p class="font-mono text-sm text-[var(--color-text-muted)]">Loading...</p>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 border-t border-[var(--color-border)]/50">
      <p class="font-mono text-xs text-[var(--color-text-dim)]">
        Updated via Claude • Powered by vibes
      </p>
    </footer>
  </div>

  <script define:vars={{ allData, sortedDates, availableDates, cycleName: plan.cycle.name }}>
    // Determine user's actual today
    const userToday = new Date().toLocaleDateString('en-CA');

    // Always show today - if no workout, it will show rest day
    const displayDate = userToday;

    const dayData = allData[displayDate];
    const todayPlan = dayData?.plan;
    const todayLog = dayData?.log;

    // Format date for display
    const dateObj = new Date(displayDate + 'T12:00:00');
    const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Calculate stats
    const totalExercises = todayPlan?.exercises?.length || 0;
    const completedExercises = todayLog?.exercises?.filter(e => e.done)?.length || 0;
    const progressPct = totalExercises > 0 ? (completedExercises / totalExercises) * 94 : 0;

    // Helper to get last week's kg
    function getLastWeekKg(exerciseId) {
      const lastWeekDate = new Date(dateObj);
      lastWeekDate.setDate(lastWeekDate.getDate() - 7);
      const lastWeekDateStr = lastWeekDate.toISOString().split('T')[0];
      const lastWeekLog = allData[lastWeekDateStr]?.log;
      if (!lastWeekLog?.exercises) return null;
      const exercise = lastWeekLog.exercises.find(e => e.id === exerciseId);
      return exercise?.actual_kg || null;
    }

    // Helper to get exercise log
    function getExerciseLog(exerciseId) {
      if (!todayLog?.exercises) return null;
      return todayLog.exercises.find(e => e.id === exerciseId);
    }

    // Render exercise row
    function renderExercise(exercise) {
      const exerciseLog = getExerciseLog(exercise.id);
      const lastWeekKg = getLastWeekKg(exercise.id);

      const isPending = exerciseLog?.done === undefined;
      const isSkipped = exerciseLog?.done === false;
      const isComplete = exerciseLog?.done === true;

      const actualKg = exerciseLog?.actual_kg;
      const targetKg = exercise.target_kg;
      const beatTarget = actualKg && targetKg && actualKg > targetKg;
      const metTarget = actualKg && targetKg && actualKg === targetKg;
      const missedTarget = actualKg && targetKg && actualKg < targetKg;

      const vsLastWeek = actualKg && lastWeekKg ? actualKg - lastWeekKg : null;

      let borderClass = 'border-[var(--color-border)]';
      if (isPending) borderClass = 'border-[var(--color-amber)]';
      if (isSkipped) borderClass = 'border-[var(--color-red)]';

      let statusIcon = '';
      if (isComplete) {
        const bgClass = beatTarget ? 'bg-lime text-black' : 'bg-[var(--color-border)] text-[var(--color-text-muted)]';
        statusIcon = `<div class="w-6 h-6 rounded-full flex items-center justify-center ${bgClass}">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
          </svg>
        </div>`;
      } else if (isPending) {
        statusIcon = `<div class="w-6 h-6 rounded-full border-2 border-[var(--color-amber)] border-dashed flex items-center justify-center">
          <div class="w-2 h-2 rounded-full bg-[var(--color-amber)]"></div>
        </div>`;
      } else if (isSkipped) {
        statusIcon = `<div class="w-6 h-6 rounded-full bg-[var(--color-red)]/20 flex items-center justify-center">
          <svg class="w-4 h-4 text-[var(--color-red)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
          </svg>
        </div>`;
      }

      let weightHtml = '';
      if (targetKg) {
        weightHtml = `
          <div class="mt-3 flex items-baseline gap-2">
            <span class="font-mono text-sm text-[var(--color-text-dim)]">Target:</span>
            <span class="font-mono text-lg text-[var(--color-text-muted)]">${targetKg}kg</span>
            ${actualKg ? `
              <span class="text-[var(--color-text-dim)]">→</span>
              <span class="font-mono text-lg font-semibold ${beatTarget ? 'text-lime' : ''} ${metTarget ? 'text-[var(--color-text)]' : ''} ${missedTarget ? 'text-[var(--color-amber)]' : ''}">${actualKg}kg</span>
              ${beatTarget ? `<span class="font-mono text-sm text-lime">+${actualKg - targetKg}kg</span>` : ''}
            ` : ''}
          </div>
        `;
      }

      let lastWeekHtml = '';
      if (lastWeekKg && isComplete && vsLastWeek !== null) {
        if (vsLastWeek > 0) {
          lastWeekHtml = `<div class="mt-2 flex items-center gap-2">
            <span class="font-mono text-xs text-[var(--color-text-dim)]">vs last week:</span>
            <span class="font-mono text-xs text-lime">+${vsLastWeek}kg</span>
          </div>`;
        } else if (vsLastWeek < 0) {
          lastWeekHtml = `<div class="mt-2 flex items-center gap-2">
            <span class="font-mono text-xs text-[var(--color-text-dim)]">vs last week:</span>
            <span class="font-mono text-xs text-[var(--color-amber)]">${vsLastWeek}kg</span>
          </div>`;
        }
      }

      const feelingHtml = exerciseLog?.feeling ? `<p class="mt-2 text-sm text-[var(--color-text-muted)] italic">"${exerciseLog.feeling}"</p>` : '';

      return `
        <div class="relative p-4 rounded-xl border bg-[var(--color-card)] ${borderClass}">
          <div class="absolute top-4 right-4">${statusIcon}</div>
          <h3 class="font-display text-xl pr-8 ${isSkipped ? 'text-[var(--color-text-muted)] line-through' : 'text-[var(--color-text)]'}">${exercise.name}</h3>
          <p class="font-mono text-sm text-[var(--color-text-muted)] mt-1">${exercise.sets}</p>
          ${weightHtml}
          ${lastWeekHtml}
          ${feelingHtml}
        </div>
      `;
    }

    // Build HTML content
    let html = '';

    // Header
    html += `
      <header class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-0.5 rounded text-xs font-mono bg-lime text-black">TODAY</span>
              ${cycleName ? `<p class="font-mono text-xs text-[var(--color-text-dim)] uppercase tracking-wider">${cycleName}</p>` : ''}
            </div>
            <h1 class="font-display text-4xl text-[var(--color-text)] mt-1">${dayName}</h1>
            <p class="font-mono text-sm text-[var(--color-text-muted)]">${dateDisplay}</p>
          </div>
          <div class="relative w-16 h-16">
            <svg class="w-16 h-16 -rotate-90" viewBox="0 0 36 36">
              <circle cx="18" cy="18" r="15" fill="none" stroke="var(--color-border)" stroke-width="3" />
              <circle cx="18" cy="18" r="15" fill="none" stroke="var(--color-lime)" stroke-width="3" stroke-linecap="round" stroke-dasharray="${progressPct} 94" />
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="font-mono text-sm font-semibold text-[var(--color-text)]">${completedExercises}/${totalExercises}</span>
            </div>
          </div>
        </div>
        ${todayPlan ? `
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-[var(--color-card)] border border-[var(--color-border)]">
            <div class="w-2 h-2 rounded-full ${todayLog?.completed ? 'bg-lime' : 'bg-[var(--color-amber)]'}"></div>
            <span class="font-mono text-sm text-[var(--color-text)]">${todayPlan.type}</span>
          </div>
        ` : ''}
      </header>
    `;

    if (todayPlan) {
      // Warmup
      if (todayPlan.warmup) {
        html += `
          <section class="mb-6">
            <div class="p-4 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
              <span class="font-mono text-xs text-[var(--color-text)] uppercase">Warmup</span>
              <p class="text-sm text-[var(--color-text)] mt-1">${todayPlan.warmup}</p>
            </div>
          </section>
        `;
      }

      // Main exercises
      if (todayPlan.exercises?.length > 0) {
        html += `
          <section class="mb-8">
            <div class="mb-4">
              <h2 class="font-display text-2xl text-[var(--color-text)] uppercase">Main Work</h2>
              <p class="font-mono text-xs text-[var(--color-text)] mt-1">${todayPlan.exercises.length} exercises</p>
            </div>
            <div class="space-y-3">
              ${todayPlan.exercises.map(e => renderExercise(e)).join('')}
            </div>
          </section>
        `;
      }

      // Core
      if (todayPlan.core?.length > 0) {
        html += `
          <section class="mb-8">
            <div class="mb-4">
              <h2 class="font-display text-2xl text-[var(--color-text)] uppercase">Core</h2>
            </div>
            <div class="grid grid-cols-2 gap-3">
              ${todayPlan.core.map(exercise => `
                <div class="p-3 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
                  <h4 class="font-display text-base text-[var(--color-text)]">${exercise.name}</h4>
                  <p class="font-mono text-xs text-[var(--color-text-muted)] mt-1">${exercise.sets}</p>
                  ${todayLog?.core_done ? `
                    <div class="mt-2">
                      <span class="inline-flex items-center gap-1 text-xs text-lime">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Done
                      </span>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          </section>
        `;
      }

      // Finisher
      if (todayPlan.finisher) {
        html += `
          <section class="mb-8">
            <div class="mb-4">
              <h2 class="font-display text-2xl text-[var(--color-text)] uppercase">Finisher</h2>
            </div>
            <div class="p-4 rounded-xl bg-[var(--color-card)] border ${todayLog?.finisher_done ? 'border-lime' : 'border-[var(--color-border)]'}">
              <div class="flex items-start justify-between">
                <div>
                  <h4 class="font-display text-lg text-[var(--color-text)]">${todayPlan.finisher.name}</h4>
                  ${todayPlan.finisher.rounds ? `<p class="font-mono text-sm text-[var(--color-text-muted)] mt-1">${todayPlan.finisher.rounds} rounds</p>` : ''}
                  ${todayPlan.finisher.details ? `<p class="text-sm text-[var(--color-text-muted)] mt-2">${todayPlan.finisher.details}</p>` : ''}
                </div>
                ${todayLog?.finisher_done ? `
                  <div class="flex flex-col items-end">
                    <span class="text-lime font-mono text-sm">Done</span>
                    ${todayLog.finisher_time ? `<span class="font-mono text-xl font-bold text-lime mt-1">${todayLog.finisher_time}</span>` : ''}
                  </div>
                ` : ''}
              </div>
            </div>
          </section>
        `;
      }

      // Mobility
      if (todayPlan.mobility) {
        html += `
          <section class="mb-8">
            <div class="mb-4">
              <h2 class="font-display text-2xl text-[var(--color-text)] uppercase">Mobility</h2>
              ${todayPlan.mobility.duration ? `<p class="font-mono text-xs text-[var(--color-text)] mt-1">${todayPlan.mobility.duration}</p>` : ''}
            </div>
            <div class="p-4 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
              <h4 class="font-display text-lg text-[var(--color-text)]">${todayPlan.mobility.name}</h4>
              ${todayPlan.mobility.details ? `<p class="text-sm text-[var(--color-text-muted)] mt-2">${todayPlan.mobility.details}</p>` : ''}
              ${todayLog?.mobility_done ? `
                <div class="mt-3">
                  <span class="inline-flex items-center gap-1 text-xs text-lime">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Completed
                  </span>
                </div>
              ` : ''}
            </div>
          </section>
        `;
      }

      // Session note
      if (todayLog?.session_note) {
        html += `
          <section class="mb-6">
            <div class="p-4 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
              <span class="font-mono text-xs text-[var(--color-text)] uppercase">Session Notes</span>
              <p class="text-sm text-[var(--color-text)] mt-2">"${todayLog.session_note}"</p>
            </div>
          </section>
        `;
      }

      // Claude insight
      if (todayLog?.claude_insight) {
        html += `
          <section class="mb-8">
            <div class="p-4 rounded-xl bg-gradient-to-br from-[var(--color-card)] to-[#1a1a1a] border border-[var(--color-border)] relative overflow-hidden">
              <div class="absolute top-0 right-0 w-20 h-20 bg-lime/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-lime/10 flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-lime" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                  </svg>
                </div>
                <div>
                  <span class="font-mono text-xs text-lime uppercase tracking-wider">Claude's Take</span>
                  <p class="text-sm text-[var(--color-text)] mt-2 leading-relaxed">${todayLog.claude_insight}</p>
                </div>
              </div>
            </div>
          </section>
        `;
      }
    } else {
      // No workout today
      html += `
        <div class="text-center py-12">
          <div class="w-16 h-16 rounded-full bg-[var(--color-card)] border border-[var(--color-border)] mx-auto flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-[var(--color-text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </div>
          <h2 class="font-display text-2xl text-[var(--color-text-muted)]">Rest Day</h2>
          <p class="text-sm text-[var(--color-text-dim)] mt-2">No workout scheduled for today.</p>
        </div>
      `;
    }

    // Render content
    document.getElementById('workout-content').innerHTML = html;

    // Regenerate week nav for the correct week
    function renderWeekNav() {
      const [year, month, day] = displayDate.split('-').map(Number);
      const currentDateObj = new Date(year, month - 1, day, 12, 0, 0);
      const dayOfWeek = currentDateObj.getDay();
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

      const dayLetters = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
      const weekDates = [];

      for (let i = 0; i < 7; i++) {
        const d = new Date(year, month - 1, day + mondayOffset + i, 12, 0, 0);
        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        weekDates.push({
          date: dateStr,
          dayLetter: dayLetters[i],
          dayNum: d.getDate(),
          hasWorkout: availableDates.includes(dateStr),
          isCurrent: dateStr === displayDate,
          isToday: dateStr === userToday
        });
      }

      // Find prev/next workout dates relative to displayed date
      const sortedAvailable = [...availableDates].sort();
      // Find most recent past workout and next future workout
      const prevDate = sortedAvailable.filter(d => d < displayDate).pop() || null;
      const nextDate = sortedAvailable.find(d => d > displayDate) || null;

      const weekNavHtml = `
        <nav class="flex items-center justify-between mb-6">
          <a href="${prevDate ? `/day/${prevDate}` : '#'}" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors ${prevDate ? 'bg-[var(--color-card)] border border-[var(--color-border)] hover:border-[var(--color-lime)]' : 'opacity-30 pointer-events-none'}">
            <svg class="w-5 h-5 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </a>
          <div class="flex gap-1">
            ${weekDates.map(day => `
              <a href="${day.hasWorkout ? `/day/${day.date}` : '#'}" data-date="${day.date}" class="week-day-btn w-9 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-mono transition-all ${day.isCurrent ? 'bg-lime text-black' : ''} ${!day.isCurrent && day.hasWorkout ? 'bg-[var(--color-card)] border border-[var(--color-border)] hover:border-[var(--color-lime)] text-[var(--color-text)]' : ''} ${!day.isCurrent && !day.hasWorkout ? 'text-[var(--color-text-dim)] pointer-events-none' : ''}">
                <span class="text-[10px] opacity-70">${day.dayLetter}</span>
                <span class="day-num font-semibold ${day.isToday && !day.isCurrent ? 'underline decoration-lime' : ''}">${day.dayNum}</span>
              </a>
            `).join('')}
          </div>
          <a href="${nextDate ? `/day/${nextDate}` : '#'}" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors ${nextDate ? 'bg-[var(--color-card)] border border-[var(--color-border)] hover:border-[var(--color-lime)]' : 'opacity-30 pointer-events-none'}">
            <svg class="w-5 h-5 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </nav>
      `;

      document.getElementById('week-nav-container').innerHTML = weekNavHtml;
    }

    renderWeekNav();
  </script>
</Layout>
