---
import Layout from '../layouts/Layout.astro';
import ExerciseRow from '../components/ExerciseRow.astro';
import ClaudeInsight from '../components/ClaudeInsight.astro';
import SectionHeader from '../components/SectionHeader.astro';
import FinisherBlock from '../components/FinisherBlock.astro';
import WeekNav from '../components/WeekNav.astro';

// Import data
import plan from '../../data/plan.json';
import log from '../../data/log.json';

// Get all available dates for checking
const allDates: string[] = [];
for (const week of Object.values(plan.weeks) as Record<string, any>[]) {
  allDates.push(...Object.keys(week));
}
const sortedDates = allDates.sort();

// Default to first available date (will be overridden by client-side script)
const today = sortedDates[0] || new Date().toLocaleDateString('en-CA');

// Get all available dates for navigation
const availableDates: string[] = [];
for (const week of Object.values(plan.weeks) as Record<string, any>[]) {
  availableDates.push(...Object.keys(week));
}

// Find today's workout across all weeks in plan
let todayPlan = null;
for (const week of Object.values(plan.weeks) as Record<string, any>[]) {
  if (week[today]) {
    todayPlan = week[today];
    break;
  }
}
const todayLog = (log as Record<string, any>)[today];

// Format date for display
const dateObj = new Date(today + 'T00:00:00');
const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

// Helper to find log data for an exercise
function getExerciseLog(exerciseId: string) {
  if (!todayLog?.exercises) return null;
  return todayLog.exercises.find((e: any) => e.id === exerciseId);
}

// Helper to get last week's log for the same exercise
function getLastWeekKg(exerciseId: string): number | null {
  const lastWeekDate = new Date(dateObj);
  lastWeekDate.setDate(lastWeekDate.getDate() - 7);
  const lastWeekDateStr = lastWeekDate.toISOString().split('T')[0];
  const lastWeekLog = (log as Record<string, any>)[lastWeekDateStr];
  if (!lastWeekLog?.exercises) return null;
  const exercise = lastWeekLog.exercises.find((e: any) => e.id === exerciseId);
  return exercise?.actual_kg || null;
}

// Calculate session stats
const totalExercises = todayPlan?.exercises?.length || 0;
const completedExercises = todayLog?.exercises?.filter((e: any) => e.done)?.length || 0;
---

<Layout title="Treino - Today's Workout">
  <div class="px-4 pt-6 max-w-lg mx-auto">
    <!-- Week Navigation -->
    <WeekNav currentDate={today} availableDates={availableDates} />

    <!-- Header -->
    <header class="mb-8 animate-fade-up">
      <div class="flex items-center justify-between mb-4">
        <div>
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 rounded text-xs font-mono bg-lime text-black">TODAY</span>
            <p class="font-mono text-xs text-[var(--color-text-dim)] uppercase tracking-wider">
              {plan.cycle.name}
            </p>
          </div>
          <h1 class="font-display text-4xl text-[var(--color-text)] mt-1">
            {dayName}
          </h1>
          <p class="font-mono text-sm text-[var(--color-text-muted)]">{dateDisplay}</p>
        </div>

        <!-- Progress ring -->
        <div class="relative w-16 h-16">
          <svg class="w-16 h-16 -rotate-90" viewBox="0 0 36 36">
            <circle
              cx="18" cy="18" r="15"
              fill="none"
              stroke="var(--color-border)"
              stroke-width="3"
            />
            <circle
              cx="18" cy="18" r="15"
              fill="none"
              stroke="var(--color-lime)"
              stroke-width="3"
              stroke-linecap="round"
              stroke-dasharray={`${totalExercises > 0 ? (completedExercises / totalExercises) * 94 : 0} 94`}
              class="transition-all duration-500"
            />
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <span class="font-mono text-sm font-semibold text-[var(--color-text)]">
              {completedExercises}/{totalExercises}
            </span>
          </div>
        </div>
      </div>

      <!-- Workout type badge -->
      {todayPlan && (
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-[var(--color-card)] border border-[var(--color-border)]">
          <div class={`w-2 h-2 rounded-full ${todayLog?.completed ? 'bg-lime' : 'bg-[var(--color-amber)]'}`}></div>
          <span class="font-mono text-sm text-[var(--color-text)]">{todayPlan.type}</span>
        </div>
      )}
    </header>

    {todayPlan ? (
      <>
        <!-- Warmup -->
        {todayPlan.warmup && (
          <section class="mb-6 animate-fade-up stagger-1">
            <div class="p-3 rounded-lg bg-[var(--color-card)]/50 border border-[var(--color-border)]/50">
              <span class="font-mono text-xs text-[var(--color-text-dim)] uppercase">Warmup</span>
              <p class="text-sm text-[var(--color-text-muted)] mt-1">{todayPlan.warmup}</p>
            </div>
          </section>
        )}

        <!-- Main exercises -->
        <section class="mb-8 animate-fade-up stagger-2">
          <SectionHeader title="Main Work" subtitle={`${todayPlan.exercises.length} exercises`} />
          <div class="space-y-3">
            {todayPlan.exercises.map((exercise: any, i: number) => {
              const exerciseLog = getExerciseLog(exercise.id);
              const lastWeekKg = getLastWeekKg(exercise.id);
              return (
                <div class={`animate-fade-up stagger-${Math.min(i + 3, 8)}`}>
                  <ExerciseRow
                    name={exercise.name}
                    sets={exercise.sets}
                    targetKg={exercise.target_kg}
                    actualKg={exerciseLog?.actual_kg}
                    done={exerciseLog?.done}
                    feeling={exerciseLog?.feeling}
                    notes={exercise.notes}
                    repsCompleted={exerciseLog?.reps_completed}
                    lastWeekKg={lastWeekKg}
                  />
                </div>
              );
            })}
          </div>
        </section>

        <!-- Core -->
        {todayPlan.core && todayPlan.core.length > 0 && (
          <section class="mb-8 animate-fade-up stagger-6">
            <SectionHeader title="Core" />
            <div class="grid grid-cols-2 gap-3">
              {todayPlan.core.map((exercise: any) => (
                <div class="p-3 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
                  <h4 class="font-display text-base text-[var(--color-text)]">{exercise.name}</h4>
                  <p class="font-mono text-xs text-[var(--color-text-muted)] mt-1">{exercise.sets}</p>
                  {todayLog?.core_done && (
                    <div class="mt-2">
                      <span class="inline-flex items-center gap-1 text-xs text-lime">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Done
                      </span>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- Finisher -->
        {todayPlan.finisher && (
          <section class="mb-8 animate-fade-up stagger-7">
            <SectionHeader title="Finisher" />
            <FinisherBlock
              name={todayPlan.finisher.name}
              rounds={todayPlan.finisher.rounds}
              details={todayPlan.finisher.details}
              done={todayLog?.finisher_done}
              time={todayLog?.finisher_time}
            />
          </section>
        )}

        <!-- Mobility (for cardio/recovery days) -->
        {todayPlan.mobility && (
          <section class="mb-8 animate-fade-up stagger-7">
            <SectionHeader title="Mobility" subtitle={todayPlan.mobility.duration} />
            <div class="p-4 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
              <h4 class="font-display text-lg text-[var(--color-text)]">{todayPlan.mobility.name}</h4>
              {todayPlan.mobility.details && (
                <p class="text-sm text-[var(--color-text-muted)] mt-2">{todayPlan.mobility.details}</p>
              )}
            </div>
          </section>
        )}

        <!-- Session note -->
        {todayLog?.session_note && (
          <section class="mb-6 animate-fade-up stagger-8">
            <div class="p-4 rounded-xl bg-[var(--color-card)] border border-[var(--color-border)]">
              <span class="font-mono text-xs text-[var(--color-text-dim)] uppercase">Session Notes</span>
              <p class="text-sm text-[var(--color-text)] mt-2">"{todayLog.session_note}"</p>
            </div>
          </section>
        )}

        <!-- Claude insight -->
        {todayLog?.claude_insight && (
          <section class="mb-8 animate-fade-up stagger-8">
            <ClaudeInsight insight={todayLog.claude_insight} />
          </section>
        )}
      </>
    ) : (
      <!-- No workout today -->
      <div class="text-center py-12">
        <div class="w-16 h-16 rounded-full bg-[var(--color-card)] border border-[var(--color-border)] mx-auto flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-[var(--color-text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
        </div>
        <h2 class="font-display text-2xl text-[var(--color-text-muted)]">Rest Day</h2>
        <p class="text-sm text-[var(--color-text-dim)] mt-2">No workout scheduled for today.</p>
      </div>
    )}

    <!-- Footer -->
    <footer class="text-center py-6 border-t border-[var(--color-border)]/50">
      <p class="font-mono text-xs text-[var(--color-text-dim)]">
        Updated via Claude â€¢ Powered by vibes
      </p>
    </footer>
  </div>

  <script define:vars={{ sortedDates, today }}>
    // Client-side: detect user's local date and redirect if needed
    const userToday = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD

    // If we're showing the wrong date, redirect to correct one
    if (userToday !== today) {
      // Check if user's today has a workout
      if (sortedDates.includes(userToday)) {
        window.location.replace(`/day/${userToday}`);
      }
    }
  </script>
</Layout>
